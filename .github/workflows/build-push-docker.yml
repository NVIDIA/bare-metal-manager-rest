# SPDX-FileCopyrightText: Copyright (c) 2021-2023 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: LicenseRef-NvidiaProprietary
#
# NVIDIA CORPORATION, its affiliates and licensors retain all intellectual
# property and proprietary rights in and to this material, related
# documentation and any modifications thereto. Any use, reproduction,
# disclosure or distribution of this material and related documentation
# without an express license agreement from NVIDIA CORPORATION or
# its affiliates is strictly prohibited.

name: Build and Push Docker Images to NVCR

on:
  workflow_call:
    inputs:
      runner:
        description: "Runner type for the build jobs"
        required: false
        default: "ubuntu-latest"
        type: string
      semantic_version:
        description: "Semantic version from VERSION file"
        required: true
        type: string
      short_sha:
        description: "Short SHA for tagging"
        required: true
        type: string
      branch_sha_tag:
        description: "Combined branch name and short SHA tag (branchname-sha)"
        required: true
        type: string
      target_registry:
        description: "Target NVCR registry path"
        required: true
        type: string
      push_enabled:
        description: "Whether to push images to registry"
        required: false
        default: true
        type: boolean
      branch_name:
        description: "Sanitized branch name for image tags"
        required: true
        type: string
      is_main_branch:
        description: "Whether to push 'latest' and version tags (only on main) - pass 'true' or 'false' as string"
        required: false
        default: "false"
        type: string
    secrets:
      NVCR_USERNAME:
        description: "NVIDIA Container Registry username (typically '$oauthtoken')"
        required: false
      NVCR_TOKEN:
        description: "NVIDIA Container Registry API token"
        required: false

# Required secrets (must be configured in GitHub repository settings):
# - NVCR_USERNAME: NVIDIA Container Registry username (typically '$oauthtoken')
# - NVCR_TOKEN: NVIDIA Container Registry API token
#
# To configure secrets:
# 1. Go to your GitHub repository settings
# 2. Navigate to Secrets and variables > Actions
# 3. Click "New repository secret"
# 4. Add the following secrets:
#    - Name: NVCR_USERNAME
#      Value: $oauthtoken (or your NVCR username)
#    - Name: NVCR_TOKEN
#      Value: Your NVIDIA NGC API token (get from https://ngc.nvidia.com/)

jobs:
  # Build and push carbide-rest-api
  build-carbide-rest-api:
    name: Build carbide-rest-api
    runs-on: ${{ inputs.runner }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to NVCR
        if: inputs.push_enabled
        uses: docker/login-action@v3
        with:
          registry: nvcr.io
          username: ${{ secrets.NVCR_USERNAME }}
          password: ${{ secrets.NVCR_TOKEN }}

      - name: Determine Docker tags
        id: docker-tags
        run: |
          # Always include branch-sha tag
          TAGS="${{ inputs.target_registry }}/carbide-rest-api:${{ inputs.branch_sha_tag }}"
          
          # On main branch, also add semantic version and latest tags
          # Check both the input and github.ref_name for robustness (handles force push edge cases)
          if [ "${{ inputs.is_main_branch }}" = "true" ] || [ "${{ github.ref_name }}" = "main" ]; then
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-api:${{ inputs.semantic_version }}"
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-api:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "DEBUG: is_main_branch=${{ inputs.is_main_branch }}, ref_name=${{ github.ref_name }}, tags=$TAGS"

      - name: Build carbide-rest-api
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/Dockerfile.carbide-rest-api
          platforms: linux/amd64
          push: ${{ inputs.push_enabled }}
          load: true
          tags: ${{ steps.docker-tags.outputs.tags }}
          cache-from: type=gha,scope=carbide-rest-api
          cache-to: type=gha,mode=max,scope=carbide-rest-api
          labels: |
            org.opencontainers.image.title=carbide-rest-api
            org.opencontainers.image.version=${{ inputs.semantic_version }}
            org.opencontainers.image.revision=${{ inputs.short_sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.url=${{ github.repositoryUrl }}

      - name: Extract binary from image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          mkdir -p artifacts
          docker create --name temp-container ${{ inputs.target_registry }}/carbide-rest-api:${{ inputs.branch_sha_tag }}
          docker cp temp-container:/app/api artifacts/api
          docker rm temp-container
          chmod +x artifacts/api

      - name: Export Docker image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          docker save ${{ inputs.target_registry }}/carbide-rest-api:${{ inputs.branch_sha_tag }} | gzip > artifacts/carbide-rest-api-${{ inputs.branch_sha_tag }}.tar.gz

      - name: Upload binary artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-api-binary
          display-name: carbide-rest-api-binary
          description: Carbide REST API binary
          version: ${{ inputs.semantic_version }}
          path: artifacts/api
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-api-binary
          display-name: carbide-rest-api-binary
          description: Carbide REST API binary
          version: latest
          path: artifacts/api
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-api-binary
          display-name: carbide-rest-api-binary
          description: Carbide REST API binary
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/api
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-api-image
          display-name: carbide-rest-api-image
          description: Carbide REST API image
          version: ${{ inputs.semantic_version }}
          path: artifacts/carbide-rest-api-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-api-image
          display-name: carbide-rest-api-image
          description: Carbide REST API image
          version: latest
          path: artifacts/carbide-rest-api-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-api-image
          display-name: carbide-rest-api-image
          description: Carbide REST API image
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/carbide-rest-api-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

  # Build and push carbide-rest-db
  build-carbide-rest-db:
    name: Build carbide-rest-db
    runs-on: ${{ inputs.runner }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to NVCR
        if: inputs.push_enabled
        uses: docker/login-action@v3
        with:
          registry: nvcr.io
          username: ${{ secrets.NVCR_USERNAME }}
          password: ${{ secrets.NVCR_TOKEN }}

      - name: Determine Docker tags
        id: docker-tags
        run: |
          # Always include branch-sha tag
          TAGS="${{ inputs.target_registry }}/carbide-rest-db:${{ inputs.branch_sha_tag }}"
          
          # On main branch, also add semantic version and latest tags
          # Check both the input and github.ref_name for robustness (handles force push edge cases)
          if [ "${{ inputs.is_main_branch }}" = "true" ] || [ "${{ github.ref_name }}" = "main" ]; then
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-db:${{ inputs.semantic_version }}"
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-db:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Build carbide-rest-db
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/Dockerfile.carbide-rest-db
          platforms: linux/amd64
          push: ${{ inputs.push_enabled }}
          load: true
          tags: ${{ steps.docker-tags.outputs.tags }}
          cache-from: type=gha,scope=carbide-rest-db
          cache-to: type=gha,mode=max,scope=carbide-rest-db
          labels: |
            org.opencontainers.image.title=carbide-rest-db
            org.opencontainers.image.version=${{ inputs.semantic_version }}
            org.opencontainers.image.revision=${{ inputs.short_sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.url=${{ github.repositoryUrl }}

      - name: Extract binary from image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          mkdir -p artifacts
          docker create --name temp-container ${{ inputs.target_registry }}/carbide-rest-db:${{ inputs.branch_sha_tag }}
          docker cp temp-container:/app/migrations artifacts/migrations
          docker rm temp-container
          chmod +x artifacts/migrations

      - name: Export Docker image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          docker save ${{ inputs.target_registry }}/carbide-rest-db:${{ inputs.branch_sha_tag }} | gzip > artifacts/carbide-rest-db-${{ inputs.branch_sha_tag }}.tar.gz

      - name: Upload binary artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-db-binary
          display-name: carbide-rest-db-binary
          description: Carbide REST DB binary
          version: ${{ inputs.semantic_version }}
          path: artifacts/migrations
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-db-binary
          display-name: carbide-rest-db-binary
          description: Carbide REST DB binary
          version: latest
          path: artifacts/migrations
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-db-binary
          display-name: carbide-rest-db-binary
          description: Carbide REST DB binary
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/migrations
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-db-image
          display-name: carbide-rest-db-image
          description: Carbide REST DB image
          version: ${{ inputs.semantic_version }}
          path: artifacts/carbide-rest-db-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-db-image
          display-name: carbide-rest-db-image
          description: Carbide REST DB image
          version: latest
          path: artifacts/carbide-rest-db-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-db-image
          display-name: carbide-rest-db-image
          description: Carbide REST DB image
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/carbide-rest-db-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

  # Build and push carbide-rest-site-manager
  build-carbide-rest-site-manager:
    name: Build carbide-rest-site-manager
    runs-on: ${{ inputs.runner }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to NVCR
        if: inputs.push_enabled
        uses: docker/login-action@v3
        with:
          registry: nvcr.io
          username: ${{ secrets.NVCR_USERNAME }}
          password: ${{ secrets.NVCR_TOKEN }}

      - name: Determine Docker tags
        id: docker-tags
        run: |
          # Always include branch-sha tag
          TAGS="${{ inputs.target_registry }}/carbide-rest-site-manager:${{ inputs.branch_sha_tag }}"
          
          # On main branch, also add semantic version and latest tags
          # Check both the input and github.ref_name for robustness (handles force push edge cases)
          if [ "${{ inputs.is_main_branch }}" = "true" ] || [ "${{ github.ref_name }}" = "main" ]; then
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-site-manager:${{ inputs.semantic_version }}"
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-site-manager:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Build carbide-rest-site-manager
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/Dockerfile.carbide-rest-site-manager
          platforms: linux/amd64
          push: ${{ inputs.push_enabled }}
          load: true
          tags: ${{ steps.docker-tags.outputs.tags }}
          cache-from: type=gha,scope=carbide-rest-site-manager
          cache-to: type=gha,mode=max,scope=carbide-rest-site-manager
          labels: |
            org.opencontainers.image.title=carbide-rest-site-manager
            org.opencontainers.image.version=${{ inputs.semantic_version }}
            org.opencontainers.image.revision=${{ inputs.short_sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.url=${{ github.repositoryUrl }}

      - name: Extract binary from image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          mkdir -p artifacts
          docker create --name temp-container ${{ inputs.target_registry }}/carbide-rest-site-manager:${{ inputs.branch_sha_tag }}
          docker cp temp-container:/app/sitemgr artifacts/sitemgr
          docker rm temp-container
          chmod +x artifacts/sitemgr

      - name: Export Docker image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          docker save ${{ inputs.target_registry }}/carbide-rest-site-manager:${{ inputs.branch_sha_tag }} | gzip > artifacts/carbide-rest-site-manager-${{ inputs.branch_sha_tag }}.tar.gz

      - name: Upload binary artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-manager-binary
          display-name: carbide-rest-site-manager-binary
          description: Carbide REST Site Manager binary
          version: ${{ inputs.semantic_version }}
          path: artifacts/sitemgr
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-manager-binary
          display-name: carbide-rest-site-manager-binary
          description: Carbide REST Site Manager binary
          version: latest
          path: artifacts/sitemgr
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-manager-binary
          display-name: carbide-rest-site-manager-binary
          description: Carbide REST Site Manager binary
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/sitemgr
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-manager-image
          display-name: carbide-rest-site-manager-image
          description: Carbide REST Site Manager image
          version: ${{ inputs.semantic_version }}
          path: artifacts/carbide-rest-site-manager-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-manager-image
          display-name: carbide-rest-site-manager-image
          description: Carbide REST Site Manager image
          version: latest
          path: artifacts/carbide-rest-site-manager-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-manager-image
          display-name: carbide-rest-site-manager-image
          description: Carbide REST Site Manager image
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/carbide-rest-site-manager-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

  # Build and push carbide-rest-workflow
  build-carbide-rest-workflow:
    name: Build carbide-rest-workflow
    runs-on: ${{ inputs.runner }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to NVCR
        if: inputs.push_enabled
        uses: docker/login-action@v3
        with:
          registry: nvcr.io
          username: ${{ secrets.NVCR_USERNAME }}
          password: ${{ secrets.NVCR_TOKEN }}

      - name: Determine Docker tags
        id: docker-tags
        run: |
          # Always include branch-sha tag
          TAGS="${{ inputs.target_registry }}/carbide-rest-workflow:${{ inputs.branch_sha_tag }}"
          
          # On main branch, also add semantic version and latest tags
          # Check both the input and github.ref_name for robustness (handles force push edge cases)
          if [ "${{ inputs.is_main_branch }}" = "true" ] || [ "${{ github.ref_name }}" = "main" ]; then
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-workflow:${{ inputs.semantic_version }}"
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-workflow:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Build carbide-rest-workflow
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/Dockerfile.carbide-rest-workflow
          platforms: linux/amd64
          push: ${{ inputs.push_enabled }}
          load: true
          tags: ${{ steps.docker-tags.outputs.tags }}
          cache-from: type=gha,scope=carbide-rest-workflow
          cache-to: type=gha,mode=max,scope=carbide-rest-workflow
          labels: |
            org.opencontainers.image.title=carbide-rest-workflow
            org.opencontainers.image.version=${{ inputs.semantic_version }}
            org.opencontainers.image.revision=${{ inputs.short_sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.url=${{ github.repositoryUrl }}

      - name: Extract binary from image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          mkdir -p artifacts
          docker create --name temp-container ${{ inputs.target_registry }}/carbide-rest-workflow:${{ inputs.branch_sha_tag }}
          docker cp temp-container:/app/workflow artifacts/workflow
          docker rm temp-container
          chmod +x artifacts/workflow

      - name: Export Docker image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          docker save ${{ inputs.target_registry }}/carbide-rest-workflow:${{ inputs.branch_sha_tag }} | gzip > artifacts/carbide-rest-workflow-${{ inputs.branch_sha_tag }}.tar.gz

      - name: Upload binary artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-workflow-binary
          display-name: carbide-rest-workflow-binary
          description: Carbide REST Workflow binary
          version: ${{ inputs.semantic_version }}
          path: artifacts/workflow
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-workflow-binary
          display-name: carbide-rest-workflow-binary
          description: Carbide REST Workflow binary
          version: latest
          path: artifacts/workflow
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-workflow-binary
          display-name: carbide-rest-workflow-binary
          description: Carbide REST Workflow binary
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/workflow
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-workflow-image
          display-name: carbide-rest-workflow-image
          description: Carbide REST Workflow image
          version: ${{ inputs.semantic_version }}
          path: artifacts/carbide-rest-workflow-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-workflow-image
          display-name: carbide-rest-workflow-image
          description: Carbide REST Workflow image
          version: latest
          path: artifacts/carbide-rest-workflow-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-workflow-image
          display-name: carbide-rest-workflow-image
          description: Carbide REST Workflow image
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/carbide-rest-workflow-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

  # Build and push carbide-rest-site-agent
  build-carbide-rest-site-agent:
    name: Build carbide-rest-site-agent
    runs-on: ${{ inputs.runner }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to NVCR
        if: inputs.push_enabled
        uses: docker/login-action@v3
        with:
          registry: nvcr.io
          username: ${{ secrets.NVCR_USERNAME }}
          password: ${{ secrets.NVCR_TOKEN }}

      - name: Determine Docker tags
        id: docker-tags
        run: |
          # Always include branch-sha tag
          TAGS="${{ inputs.target_registry }}/carbide-rest-site-agent:${{ inputs.branch_sha_tag }}"
          
          # On main branch, also add semantic version and latest tags
          # Check both the input and github.ref_name for robustness (handles force push edge cases)
          if [ "${{ inputs.is_main_branch }}" = "true" ] || [ "${{ github.ref_name }}" = "main" ]; then
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-site-agent:${{ inputs.semantic_version }}"
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-site-agent:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Build carbide-rest-site-agent
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/Dockerfile.carbide-rest-site-agent
          platforms: linux/amd64
          push: ${{ inputs.push_enabled }}
          load: true
          tags: ${{ steps.docker-tags.outputs.tags }}
          cache-from: type=gha,scope=carbide-rest-site-agent
          cache-to: type=gha,mode=max,scope=carbide-rest-site-agent
          labels: |
            org.opencontainers.image.title=carbide-rest-site-agent
            org.opencontainers.image.version=${{ inputs.semantic_version }}
            org.opencontainers.image.revision=${{ inputs.short_sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.url=${{ github.repositoryUrl }}

      - name: Extract binary from image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          mkdir -p artifacts
          docker create --name temp-container ${{ inputs.target_registry }}/carbide-rest-site-agent:${{ inputs.branch_sha_tag }}
          docker cp temp-container:/app/elektra artifacts/elektra
          docker rm temp-container
          chmod +x artifacts/elektra

      - name: Export Docker image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          docker save ${{ inputs.target_registry }}/carbide-rest-site-agent:${{ inputs.branch_sha_tag }} | gzip > artifacts/carbide-rest-site-agent-${{ inputs.branch_sha_tag }}.tar.gz

      - name: Upload binary artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-agent-binary
          display-name: carbide-rest-site-agent-binary
          description: Carbide Site Agent binary
          version: ${{ inputs.semantic_version }}
          path: artifacts/elektra
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-agent-binary
          display-name: carbide-rest-site-agent-binary
          description: Carbide Site Agent binary
          version: latest
          path: artifacts/elektra
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-agent-binary
          display-name: carbide-rest-site-agent-binary
          description: Carbide Site Agent binary
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/elektra
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-agent-image
          display-name: carbide-rest-site-agent-image
          description: Carbide Site Agent image
          version: ${{ inputs.semantic_version }}
          path: artifacts/carbide-rest-site-agent-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-agent-image
          display-name: carbide-rest-site-agent-image
          description: Carbide Site Agent image
          version: latest
          path: artifacts/carbide-rest-site-agent-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-site-agent-image
          display-name: carbide-rest-site-agent-image
          description: Carbide Site Agent image
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/carbide-rest-site-agent-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

  # Build and push carbide-rest-cert-manager (credsmgr)
  build-carbide-rest-cert-manager:
    name: Build carbide-rest-cert-manager
    runs-on: ${{ inputs.runner }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to NVCR
        if: inputs.push_enabled
        uses: docker/login-action@v3
        with:
          registry: nvcr.io
          username: ${{ secrets.NVCR_USERNAME }}
          password: ${{ secrets.NVCR_TOKEN }}

      - name: Determine Docker tags
        id: docker-tags
        run: |
          # Always include branch-sha tag
          TAGS="${{ inputs.target_registry }}/carbide-rest-cert-manager:${{ inputs.branch_sha_tag }}"
          
          # On main branch, also add semantic version and latest tags
          # Check both the input and github.ref_name for robustness (handles force push edge cases)
          if [ "${{ inputs.is_main_branch }}" = "true" ] || [ "${{ github.ref_name }}" = "main" ]; then
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-cert-manager:${{ inputs.semantic_version }}"
            TAGS="${TAGS},${{ inputs.target_registry }}/carbide-rest-cert-manager:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Build carbide-rest-cert-manager
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/Dockerfile.carbide-rest-cert-manager
          platforms: linux/amd64
          push: ${{ inputs.push_enabled }}
          load: true
          tags: ${{ steps.docker-tags.outputs.tags }}
          cache-from: type=gha,scope=carbide-rest-cert-manager
          cache-to: type=gha,mode=max,scope=carbide-rest-cert-manager
          labels: |
            org.opencontainers.image.title=carbide-rest-cert-manager
            org.opencontainers.image.version=${{ inputs.semantic_version }}
            org.opencontainers.image.revision=${{ inputs.short_sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.url=${{ github.repositoryUrl }}

      - name: Extract binary from image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          mkdir -p artifacts
          docker create --name temp-container ${{ inputs.target_registry }}/carbide-rest-cert-manager:${{ inputs.branch_sha_tag }}
          docker cp temp-container:/app/credsmgr artifacts/credsmgr
          docker rm temp-container
          chmod +x artifacts/credsmgr

      - name: Export Docker image
        if: inputs.is_main_branch || github.ref_name == 'main'
        run: |
          docker save ${{ inputs.target_registry }}/carbide-rest-cert-manager:${{ inputs.branch_sha_tag }} | gzip > artifacts/carbide-rest-cert-manager-${{ inputs.branch_sha_tag }}.tar.gz

      - name: Upload binary artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-cert-manager-binary
          display-name: carbide-rest-cert-manager-binary
          description: Carbide REST Cert Manager binary
          version: ${{ inputs.semantic_version }}
          path: artifacts/credsmgr
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-cert-manager-binary
          display-name: carbide-rest-cert-manager-binary
          description: Carbide REST Cert Manager binary
          version: latest
          path: artifacts/credsmgr
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload binary artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-cert-manager-binary
          display-name: carbide-rest-cert-manager-binary
          description: Carbide REST Cert Manager binary
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/credsmgr
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with semantic version
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-cert-manager-image
          display-name: carbide-rest-cert-manager-image
          description: Carbide REST Cert Manager image
          version: ${{ inputs.semantic_version }}
          path: artifacts/carbide-rest-cert-manager-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with latest tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-cert-manager-image
          display-name: carbide-rest-cert-manager-image
          description: Carbide REST Cert Manager image
          version: latest
          path: artifacts/carbide-rest-cert-manager-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

      - name: Upload Docker image artifact with branch-sha tag
        if: inputs.is_main_branch || github.ref_name == 'main'
        uses: NVIDIA/dsx-github-actions/.github/actions/resource-push-ngc@47c68bf27edde19d1acece9b7721b4a1a0044dfa
        with:
          name: carbide-rest-cert-manager-image
          display-name: carbide-rest-cert-manager-image
          description: Carbide REST Cert Manager image
          version: ${{ inputs.branch_sha_tag }}
          path: artifacts/carbide-rest-cert-manager-${{ inputs.branch_sha_tag }}.tar.gz
          ngc-path: 0837451325059433/carbide-dev
          ngc-key: ${{ secrets.NVCR_TOKEN }}

  # Build summary
  build-summary:
    name: Build Summary
    runs-on: ${{ inputs.runner }}
    needs:
      - build-carbide-rest-api
      - build-carbide-rest-db
      - build-carbide-rest-site-manager
      - build-carbide-rest-workflow
      - build-carbide-rest-site-agent
      - build-carbide-rest-cert-manager
    if: always()

    steps:
      - name: Generate build summary
        run: |
          echo "# Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Semantic Version**: \`${{ inputs.semantic_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Git SHA**: \`${{ inputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ inputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch-SHA Tag**: \`${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`${{ inputs.target_registry }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Push Enabled**: \`${{ inputs.push_enabled }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Is Main Branch**: \`${{ inputs.is_main_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref Name**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.push_enabled }}" = "false" ]; then
            echo "> **Note**: Images were built but NOT pushed to registry (build-only mode)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "## Docker Image Tags" >> $GITHUB_STEP_SUMMARY
          echo "All images tagged with: \`${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.is_main_branch }}" = "true" ] || [ "${{ github.ref_name }}" = "main" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Main branch additional tags:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`${{ inputs.semantic_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`latest\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Images Built" >> $GITHUB_STEP_SUMMARY
          echo "1. \`carbide-rest-api:${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. \`carbide-rest-db:${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. \`carbide-rest-site-manager:${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "4. \`carbide-rest-workflow:${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "5. \`carbide-rest-site-agent:${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "6. \`carbide-rest-cert-manager:${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.is_main_branch }}" = "true" ] || [ "${{ github.ref_name }}" = "main" ]; then
            echo "## Binary Artifacts Uploaded (Main Branch)" >> $GITHUB_STEP_SUMMARY
            echo "Each binary uploaded with versions: \`${{ inputs.semantic_version }}\`, \`latest\`, \`${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-api: \`${{ needs.build-carbide-rest-api.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-db: \`${{ needs.build-carbide-rest-db.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-site-manager: \`${{ needs.build-carbide-rest-site-manager.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-workflow: \`${{ needs.build-carbide-rest-workflow.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-site-agent: \`${{ needs.build-carbide-rest-site-agent.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-cert-manager: \`${{ needs.build-carbide-rest-cert-manager.result }}\`" >> $GITHUB_STEP_SUMMARY
