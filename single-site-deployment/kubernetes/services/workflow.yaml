---
apiVersion: v1
kind: Service
metadata:
  name: workflow
  namespace: carbide-system
  labels:
    app: workflow
spec:
  type: ClusterIP
  ports:
    - port: 9360
      targetPort: 9360
      name: metrics
  selector:
    app: workflow
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: workflow
  namespace: carbide-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: workflow
  template:
    metadata:
      labels:
        app: workflow
        tier: workflow
    spec:
      containers:
        - name: workflow
          image: localhost:5000/carbide-rest-workflow:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9360
              name: metrics
          env:
            - name: DB_HOST
              value: postgres.carbide-system.svc.cluster.local
            - name: DB_PORT
              value: "5432"
            - name: DB_NAME
              value: forge
            - name: DB_USER
              value: forge
            - name: DB_PASSWORD
              value: forge
            - name: TEMPORAL_HOST
              value: temporal.carbide-system.svc.cluster.local
            - name: TEMPORAL_PORT
              value: "7233"
            - name: TEMPORAL_SERVERNAME
              value: temporal.carbide-system.svc.cluster.local
            - name: TEMPORAL_NAMESPACE
              value: default
            - name: TEMPORAL_QUEUE
              value: cloud-tasks
            - name: TEMPORAL_ENCRYPTIONKEY
              value: dev-encryption-key-12345678901234567890123456789012
            - name: TEMPORAL_TLS_ENABLED
              value: "false"
            - name: TEMPORAL_CERT_PATH
              value: /var/secrets/temporal/certs
            - name: METRICS_ENABLED
              value: "true"
            - name: METRICS_PORT
              value: "9360"
          volumeMounts:
            - name: temporal-certs
              mountPath: /var/secrets/temporal/certs
              readOnly: true
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1"
      volumes:
        - name: temporal-certs
          emptyDir: {}

