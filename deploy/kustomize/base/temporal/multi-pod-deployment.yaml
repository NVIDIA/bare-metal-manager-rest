# SPDX-FileCopyrightText: Copyright (c) 2021-2023 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: LicenseRef-NvidiaProprietary
#
# NVIDIA CORPORATION, its affiliates and licensors retain all intellectual
# property and proprietary rights in and to this material, related
# documentation and any modifications thereto. Any use, reproduction,
# disclosure or distribution of this material and related documentation
# without an express license agreement from NVIDIA CORPORATION or
# its affiliates is strictly prohibited.

# Temporal multi-pod deployment with mTLS
# Each service (frontend, history, matching, worker) runs in its own pod

---
# Frontend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: temporal-frontend
  labels:
    app: temporal
    component: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: temporal
      component: frontend
  template:
    metadata:
      labels:
        app: temporal
        component: frontend
    spec:
      initContainers:
        - name: copy-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cp /config-source/* /etc/temporal/config/
              sed -i "s/POD_IP_PLACEHOLDER/$POD_IP/g" /etc/temporal/config/docker.yaml
              chmod -R 777 /etc/temporal/config/
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          volumeMounts:
            - name: config-source
              mountPath: /config-source
            - name: config
              mountPath: /etc/temporal/config
      containers:
        - name: temporal-frontend
          image: temporalio/server:1.26.2
          command: ["temporal-server"]
          args:
            - start
            - --service=frontend
          env:
            - name: TEMPORAL_ROOT
              value: /
            - name: TEMPORAL_CONFIG_DIR
              value: etc/temporal/config
            - name: TEMPORAL_ENVIRONMENT
              value: docker
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          ports:
            - containerPort: 7233
              name: grpc
            - containerPort: 6933
              name: membership
          volumeMounts:
            - name: config
              mountPath: /etc/temporal/config
            - name: tls-certs
              mountPath: /etc/temporal/certs
              readOnly: true
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          readinessProbe:
            tcpSocket:
              port: 7233
            initialDelaySeconds: 15
            periodSeconds: 5
          livenessProbe:
            tcpSocket:
              port: 7233
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: config-source
          configMap:
            name: temporal-config
        - name: config
          emptyDir: {}
        - name: tls-certs
          secret:
            secretName: temporal-frontend-tls
            items:
              - key: tls.crt
                path: tls.crt
              - key: tls.key
                path: tls.key
              - key: ca.crt
                path: ca.crt

---
# History Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: temporal-history
  labels:
    app: temporal
    component: history
spec:
  replicas: 1
  selector:
    matchLabels:
      app: temporal
      component: history
  template:
    metadata:
      labels:
        app: temporal
        component: history
    spec:
      initContainers:
        - name: copy-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cp /config-source/* /etc/temporal/config/
              sed -i "s/POD_IP_PLACEHOLDER/$POD_IP/g" /etc/temporal/config/docker.yaml
              chmod -R 777 /etc/temporal/config/
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          volumeMounts:
            - name: config-source
              mountPath: /config-source
            - name: config
              mountPath: /etc/temporal/config
      containers:
        - name: temporal-history
          image: temporalio/server:1.26.2
          command: ["temporal-server"]
          args:
            - start
            - --service=history
          env:
            - name: TEMPORAL_ROOT
              value: /
            - name: TEMPORAL_CONFIG_DIR
              value: etc/temporal/config
            - name: TEMPORAL_ENVIRONMENT
              value: docker
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          ports:
            - containerPort: 7234
              name: grpc
            - containerPort: 6934
              name: membership
          volumeMounts:
            - name: config
              mountPath: /etc/temporal/config
            - name: tls-certs
              mountPath: /etc/temporal/certs
              readOnly: true
          resources:
            requests:
              memory: "512Mi"
              cpu: "100m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          readinessProbe:
            tcpSocket:
              port: 7234
            initialDelaySeconds: 15
            periodSeconds: 5
          livenessProbe:
            tcpSocket:
              port: 7234
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: config-source
          configMap:
            name: temporal-config
        - name: config
          emptyDir: {}
        - name: tls-certs
          secret:
            secretName: temporal-history-tls
            items:
              - key: tls.crt
                path: tls.crt
              - key: tls.key
                path: tls.key
              - key: ca.crt
                path: ca.crt

---
# Matching Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: temporal-matching
  labels:
    app: temporal
    component: matching
spec:
  replicas: 1
  selector:
    matchLabels:
      app: temporal
      component: matching
  template:
    metadata:
      labels:
        app: temporal
        component: matching
    spec:
      initContainers:
        - name: copy-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cp /config-source/* /etc/temporal/config/
              sed -i "s/POD_IP_PLACEHOLDER/$POD_IP/g" /etc/temporal/config/docker.yaml
              chmod -R 777 /etc/temporal/config/
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          volumeMounts:
            - name: config-source
              mountPath: /config-source
            - name: config
              mountPath: /etc/temporal/config
      containers:
        - name: temporal-matching
          image: temporalio/server:1.26.2
          command: ["temporal-server"]
          args:
            - start
            - --service=matching
          env:
            - name: TEMPORAL_ROOT
              value: /
            - name: TEMPORAL_CONFIG_DIR
              value: etc/temporal/config
            - name: TEMPORAL_ENVIRONMENT
              value: docker
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          ports:
            - containerPort: 7235
              name: grpc
            - containerPort: 6935
              name: membership
          volumeMounts:
            - name: config
              mountPath: /etc/temporal/config
            - name: tls-certs
              mountPath: /etc/temporal/certs
              readOnly: true
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          readinessProbe:
            tcpSocket:
              port: 7235
            initialDelaySeconds: 15
            periodSeconds: 5
          livenessProbe:
            tcpSocket:
              port: 7235
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: config-source
          configMap:
            name: temporal-config
        - name: config
          emptyDir: {}
        - name: tls-certs
          secret:
            secretName: temporal-matching-tls
            items:
              - key: tls.crt
                path: tls.crt
              - key: tls.key
                path: tls.key
              - key: ca.crt
                path: ca.crt

---
# Worker Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: temporal-worker
  labels:
    app: temporal
    component: worker
spec:
  replicas: 1
  selector:
    matchLabels:
      app: temporal
      component: worker
  template:
    metadata:
      labels:
        app: temporal
        component: worker
    spec:
      initContainers:
        - name: copy-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cp /config-source/* /etc/temporal/config/
              sed -i "s/POD_IP_PLACEHOLDER/$POD_IP/g" /etc/temporal/config/docker.yaml
              chmod -R 777 /etc/temporal/config/
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          volumeMounts:
            - name: config-source
              mountPath: /config-source
            - name: config
              mountPath: /etc/temporal/config
      containers:
        - name: temporal-worker
          image: temporalio/server:1.26.2
          command: ["temporal-server"]
          args:
            - start
            - --service=worker
          env:
            - name: TEMPORAL_ROOT
              value: /
            - name: TEMPORAL_CONFIG_DIR
              value: etc/temporal/config
            - name: TEMPORAL_ENVIRONMENT
              value: docker
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          ports:
            - containerPort: 7239
              name: grpc
            - containerPort: 6939
              name: membership
          volumeMounts:
            - name: config
              mountPath: /etc/temporal/config
            - name: tls-certs
              mountPath: /etc/temporal/certs
              readOnly: true
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          # Worker service doesn't expose HTTP health endpoints
          # Use exec probe to check if the process is running
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "pgrep -f 'temporal-server.*worker' > /dev/null"
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 3
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "pgrep -f 'temporal-server.*worker' > /dev/null"
            initialDelaySeconds: 60
            periodSeconds: 20
            failureThreshold: 5
      volumes:
        - name: config-source
          configMap:
            name: temporal-config
        - name: config
          emptyDir: {}
        - name: tls-certs
          secret:
            secretName: temporal-worker-tls
            items:
              - key: tls.crt
                path: tls.crt
              - key: tls.key
                path: tls.key
              - key: ca.crt
                path: ca.crt
